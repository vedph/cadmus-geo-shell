<form [formGroup]="form" (submit)="save()">
  <mat-card>
    <mat-card-header>
      <div mat-card-avatar>
        <mat-icon>picture_in_picture</mat-icon>
      </div>
      <mat-card-title>{{
        (modelName() | titlecase) || "Locations Part"
      }}</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div id="container">
        <!-- list -->
        <div id="list">
          <div class="button-row">
            <button
              type="button"
              mat-flat-button
              class="mat-primary"
              (click)="addLocation()"
            >
              <mat-icon>add_circle</mat-icon> location
            </button>
            <button
              type="button"
              mat-icon-button
              matTooltip="Fit map to locations"
              [disabled]="!locations.value.length"
              (click)="fitMapToLocations()"
            >
              <mat-icon>fit_screen</mat-icon>
            </button>
          </div>
          @if (locations.value.length) {
            <table>
              <thead>
                <tr>
                  <th></th>
                  <th>label</th>
                  <th>lat.</th>
                  <th>lon.</th>
                </tr>
              </thead>
              <tbody>
                @for (
                  location of locations.value;
                  track location;
                  let i = $index;
                  let first = $first;
                  let last = $last
                ) {
                  <tr [class.selected]="i === editedIndex()">
                    <td class="fit-width">
                      <button
                        type="button"
                        mat-icon-button
                        matTooltip="Edit this location"
                        (click)="editLocation(location, i)"
                      >
                        <mat-icon class="mat-primary">edit</mat-icon>
                      </button>
                      <button
                        type="button"
                        mat-icon-button
                        matTooltip="Move this location up"
                        [disabled]="first"
                        (click)="moveLocationUp(i)"
                      >
                        <mat-icon>arrow_upward</mat-icon>
                      </button>
                      <button
                        type="button"
                        mat-icon-button
                        matTooltip="Move this location down"
                        [disabled]="last"
                        (click)="moveLocationDown(i)"
                      >
                        <mat-icon>arrow_downward</mat-icon>
                      </button>
                      <button
                        type="button"
                        mat-icon-button
                        matTooltip="Delete this location"
                        (click)="deleteLocation(i)"
                      >
                        <mat-icon class="mat-warn">remove_circle</mat-icon>
                      </button>
                      <button
                        type="button"
                        mat-icon-button
                        matTooltip="Fly to this location"
                        (click)="flyToLocation(location)"
                      >
                        <mat-icon>adjust</mat-icon>
                      </button>
                    </td>
                    <td>{{ location.value.label }}</td>
                    <td>{{ location.value.latitude }}</td>
                    <td>{{ location.value.longitude }}</td>
                  </tr>
                }
              </tbody>
            </table>
          }
        </div>

        <!-- editor -->
        <div id="editor">
          @if (edited()) {
            <mat-expansion-panel [expanded]="edited()" [disabled]="!edited()">
              <mat-expansion-panel-header>location</mat-expansion-panel-header>
              <cadmus-asserted-location
                [assTagEntries]="assTagEntries()"
                [locTagEntries]="locTagEntries()"
                [refTagEntries]="refTagEntries()"
                [refTypeEntries]="refTypeEntries()"
                [lookupProviderOptions]="lookupProviderOptions()"
                [location]="edited()"
                (locationChange)="saveLocation($event!)"
                (editorClose)="closeLocation()"
              />
            </mat-expansion-panel>
          }
        </div>

        <!-- overview map -->
        <div id="overview-map">
          <mgl-map
            [mapStyle]="mapStyle"
            [center]="mapCenter()"
            [zoom]="mapZoom()"
            (mapLoad)="onOverviewMapLoad($event)"
          >
            <!-- Navigation controls -->
            <mgl-control position="top-right" mglNavigation></mgl-control>
            <!-- Scale bar -->
            <mgl-control
              position="bottom-left"
              mglScale
              unit="metric"
            ></mgl-control>

            <!-- Markers for each location -->
            @for (loc of mapLocations(); track $index) {
              <mgl-marker
                [lngLat]="[loc.value.longitude, loc.value.latitude]"
                color="#3f51b5"
              >
              </mgl-marker>
            }

            <!-- Labels -->
            <mgl-geojson-source id="overview-labels" [data]="labelsGeoJSON()">
            </mgl-geojson-source>
            <mgl-layer
              id="overview-labels-text"
              type="symbol"
              source="overview-labels"
              [layout]="{
                'text-field': ['get', 'label'],
                'text-font': ['Noto Sans Regular'],
                'text-offset': [0, 1.5],
                'text-anchor': 'top',
                'text-size': 13,
              }"
              [paint]="{
                'text-color': '#3f51b5',
                'text-halo-color': '#ffffff',
                'text-halo-width': 1.5,
              }"
            ></mgl-layer>
          </mgl-map>
        </div>
      </div>
    </mat-card-content>
    <mat-card-actions>
      <cadmus-close-save-buttons
        [form]="form"
        [noSave]="userLevel < 2"
        (closeRequest)="close()"
      />
    </mat-card-actions>
  </mat-card>
</form>
